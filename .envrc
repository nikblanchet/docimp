#!/bin/bash

# Create interceptor directory
mkdir -p .direnv/bin

# Python interceptor
cat > .direnv/bin/python <<'PYTHON_EOF'
#!/bin/bash
# Intercept bare python calls and redirect to uv
echo "→ Redirecting to: uv run python" >&2
exec uv run python "$@"
PYTHON_EOF

# Python3 interceptor (same behavior)
cat > .direnv/bin/python3 <<'PYTHON3_EOF'
#!/bin/bash
# Intercept bare python3 calls and redirect to uv
echo "→ Redirecting to: uv run python" >&2
exec uv run python "$@"
PYTHON3_EOF

# pip interceptor (prevent accidental bare pip)
cat > .direnv/bin/pip <<'PIP_EOF'
#!/bin/bash
# Block bare pip, show helpful error
echo "❌ Bare 'pip' detected!" >&2
echo "" >&2
echo "Instead of 'pip install <package>', use:" >&2
echo "  uv add <package>" >&2
echo "" >&2
echo "To sync lockfile:" >&2
echo "  uv pip sync requirements-dev.lock" >&2
exit 1
PIP_EOF

# Make executables
chmod +x .direnv/bin/python
chmod +x .direnv/bin/python3
chmod +x .direnv/bin/pip

# Add to PATH (highest priority)
PATH_add .direnv/bin

# Auto-switch to Node version specified in .nvmrc
if command -v nvm &> /dev/null || [ -s "$HOME/.nvm/nvm.sh" ]; then
    # Load nvm into shell session (if not already loaded)
    if [ -z "$NVM_DIR" ]; then
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    fi

    # Auto-use .nvmrc if present
    if [ -f .nvmrc ]; then
        # Suppress "Now using node" message
        nvm use 2>&1 | grep -v "Now using"
    fi
fi

echo "✓ direnv loaded: Python commands intercepted, Node version managed"
