#!/bin/bash

# Create interceptor directory
mkdir -p .direnv/bin

# Python interceptor
cat > .direnv/bin/python <<'PYTHON_EOF'
#!/bin/bash
# Intercept bare python calls and redirect to uv
echo "→ Redirecting to: uv run python" >&2
exec uv run python "$@"
PYTHON_EOF

# Python3 interceptor (same behavior)
cat > .direnv/bin/python3 <<'PYTHON3_EOF'
#!/bin/bash
# Intercept bare python3 calls and redirect to uv
echo "→ Redirecting to: uv run python" >&2
exec uv run python "$@"
PYTHON3_EOF

# pip interceptor (prevent accidental bare pip)
cat > .direnv/bin/pip <<'PIP_EOF'
#!/bin/bash
# Block bare pip, show helpful error
echo "❌ Bare 'pip' detected!" >&2
echo "" >&2
echo "Instead of 'pip install <package>', use:" >&2
echo "  uv add <package>" >&2
echo "" >&2
echo "To sync lockfile:" >&2
echo "  uv pip sync requirements-dev.lock" >&2
exit 1
PIP_EOF

# Make executables
chmod +x .direnv/bin/python
chmod +x .direnv/bin/python3
chmod +x .direnv/bin/pip

# Add to PATH (highest priority)
PATH_add .direnv/bin

# Auto-add Node bin to PATH based on .nvmrc
# (avoids calling nvm as command, which doesn't work in direnv's restricted context)
if [ -f .nvmrc ]; then
    NODE_VERSION=$(cat .nvmrc)
    # Find matching Node version directory (handles "24" matching "v24.11.0")
    if [ -d "$HOME/.nvm/versions/node" ]; then
        NODE_PATH=$(find "$HOME/.nvm/versions/node" -maxdepth 1 -name "v${NODE_VERSION}*" | head -1)
        if [ -n "$NODE_PATH" ] && [ -d "$NODE_PATH/bin" ]; then
            PATH_add "$NODE_PATH/bin"
        fi
    fi
fi

echo "✓ direnv loaded: Python commands intercepted, Node version managed"
